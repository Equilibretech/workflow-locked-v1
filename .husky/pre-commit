#!/bin/sh
# DevFoundation Gate Validation + Quality Gates Hook

echo "ğŸ” Running DevFoundation Quality Gates..."

branch="$(git branch --show-current)"
gate_file="docs/gate-${branch}.md"

# Function to run quality checks
run_quality_gates() {
  echo "ğŸ“‹ Running pre-commit quality gates..."
  
  # 1. ESLint Check
  echo "ğŸ” Running ESLint..."
  if ! npm run lint:check > /dev/null 2>&1; then
    echo "âŒ ESLint failed - please fix linting errors"
    echo "ğŸ’¡ Run 'npm run lint:fix' to auto-fix issues"
    return 1
  fi
  echo "âœ… ESLint passed"
  
  # 2. TypeScript Build Check (quick check)
  echo "ğŸ” Checking TypeScript compilation..."
  if ! cd docs && npm run build > /dev/null 2>&1; then
    echo "âŒ TypeScript compilation failed in docs/"
    return 1
  fi
  if ! cd ../docs/wizard && npm run build > /dev/null 2>&1; then
    echo "âŒ TypeScript compilation failed in docs/wizard/"
    return 1
  fi
  cd ../../
  echo "âœ… TypeScript compilation passed"
  
  # 3. Security Audit (lightweight check)
  echo "ğŸ” Running security audit..."
  if ! npm audit --audit-level critical > /dev/null 2>&1; then
    echo "âš ï¸  Security vulnerabilities detected - please review"
    echo "ğŸ’¡ Run 'npm audit' for details"
    # Don't fail on security issues in pre-commit, just warn
  fi
  echo "âœ… Security audit completed"
  
  return 0
}

# Run quality gates for all commits
if ! run_quality_gates; then
  echo "âŒ Quality gates failed - commit blocked"
  echo "ğŸ”§ Please fix the issues above and try again"
  exit 1
fi

# Skip gate validation for certain branches
if [ "$branch" = "main" ] || [ "$branch" = "master" ] || [ "$branch" = "develop" ]; then
  echo "âœ… Quality gates passed - skipping workflow gate validation for protected branch: $branch"
  exit 0
fi

echo "ğŸšª Checking workflow gate validation..."

# Check if gate file exists
if [ ! -f "$gate_file" ]; then
  echo "âŒ Gate prÃ©cÃ©dent non validÃ© pour la branche: $branch"
  echo "â„¹ï¸  CrÃ©ez $gate_file avec claude-code '/gate-complete <N>' avant de continuer."
  echo "ğŸ“‹ Exemple: claude-code '/gate-complete 1' pour valider le gate 1"
  exit 1
fi

# Verify gate file has required content
if ! grep -q "âœ….*completed" "$gate_file"; then
  echo "âŒ Fichier gate trouvÃ© mais invalide: $gate_file"
  echo "â„¹ï¸  Le fichier doit contenir 'âœ… Gate X completed' pour Ãªtre valide"
  exit 1
fi

echo "âœ… All gates validated for branch $branch"
echo "ğŸ‰ Commit ready - quality gates and workflow gates passed!"
exit 0
